{% extends "base.html" %}

{% block title %}çµ±ä¸€é ç´„é é¢{% endblock %}

{% block content %}
    <h1>çµ±ä¸€é ç´„å„€å™¨èˆ‡æœå‹™</h1>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
    <div class="col-md-6">
        <label for="item_type_selector" class="form-label">é¸æ“‡é ç´„é¡åˆ¥ï¼š</label>
Â  Â  Â  Â Â 
	<select id="item_type_selector" class="form-select mb-3">
    	    <option value="" {% if not form.item_type.data %}selected{% endif %}>-- è«‹é¸æ“‡é ç´„é¡åˆ¥ --</option>
    
    	    <option value="instrument" {% if form.item_type.data == 'instrument' %}selected{% endif %}>å„€å™¨</option>
    	    <option value="service" {% if form.item_type.data == 'service' %}selected{% endif %}>å°ˆæ¡ˆæœå‹™</option>
</select>
        
        <label for="item_detail_selector" class="form-label" id="item_detail_label" style="display: none;">é¸æ“‡é …ç›®ï¼š</label>

        <select id="instrument_select" name="instrument_id" class="form-select mb-3 item-detail-select" style="display: none;">
Â  Â  	    <option value="" selected>-- è«‹é¸æ“‡å„€å™¨ --</option>
Â  Â  	    {% for inst in instruments %}
Â  Â  Â  Â 		 <option value="{{ inst.id }}">{{ inst.instrument_code }}: {{ inst.chinese_name }}</option>
Â  Â 	     {% endfor %}
</select>

<select id="service_select" name="service_id" class="form-select mb-3 item-detail-select" style="display: none;">
Â  Â  <option value="" selected>-- è«‹é¸æ“‡å°ˆæ¡ˆæœå‹™ --</option>
Â  Â  {% for svc in services %}
Â  Â  Â  Â  <option value="{{ svc.id }}">{{ svc.service_code }}: {{ svc.chinese_name }}</option>
Â  Â  {% endfor %}
</select>
    </div>
</div>
    
    <hr>
    
    <form method="POST" id="reservation_form">
        {{ form.hidden_tag() }}
        
        <input type="hidden" id="force_item_id" name="force_item_id" value="">
        <input type="hidden" id="force_item_type" name="force_item_type" value="">
	<div class="form-group">
            {{ form.start_time.label }}
            {{ form.start_time(class="form-control", type="datetime-local") }}
            {% for error in form.start_time.errors %}
                <span class="text-danger">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.end_time.label }}
            {{ form.end_time(class="form-control", type="datetime-local") }}
            {% for error in form.end_time.errors %}
                <span class="text-danger">{{ error }}</span>
            {% endfor %}
        </div>


        <div class="form-group">
            {{ form.purpose.label }}
            {{ form.purpose(class="form-control", rows=5, cols=40) }}
            {% for error in form.purpose.errors %}
                <span class="text-danger">{{ error }}</span>
            {% endfor %}
        </div>
        
        <div class="form-group">
            {{ form.submit(class="btn btn-primary", id="submit_button", disabled=True) }}
        </div>
    </form>
    
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // è®Šé‡å®šç¾©
    const typeSelector = document.getElementById('item_type_selector'); 
    const instrumentSelect = document.getElementById('instrument_select');
    const serviceSelect = document.getElementById('service_select');
    const itemDetailLabel = document.getElementById('item_detail_label');
    const submitButton = document.getElementById('submit_button');
    
    // ğŸš¨ æ–°å¢ï¼šå¼·åˆ¶å‚³è¼¸çš„éš±è—æ¬„ä½å’Œè¡¨å–®
    const reservationForm = document.getElementById('reservation_form'); // ç¢ºä¿æ‚¨çš„ <form> æ¨™ç±¤æœ‰ id="reservation_form"
    const forceItemId = document.getElementById('force_item_id');
    const forceItemType = document.getElementById('force_item_type');

    // ç²å–ç•¶å‰é¸ä¸­çš„æœ‰æ•ˆé …ç›® ID å’Œé¡å‹
    function getSelection() {
        const selectedType = typeSelector.value;
        let selectedItemId = '';

        if (selectedType === 'instrument') {
            selectedItemId = instrumentSelect.value;
        } else if (selectedType === 'service') {
            selectedItemId = serviceSelect.value;
        }
        
        // è‡¨æ™‚åµéŒ¯ï¼šæª¢æŸ¥é¸ä¸­çš„å¯¦éš›å€¼
        console.log("DEBUG_JS: Current Category Selection:", selectedType, selectedItemId);

        return { type: selectedType, id: selectedItemId };
    }

    function updateSubmitButton() {
        const selection = getSelection();
        const canSubmit = selection.type && selection.id; 
        submitButton.disabled = !canSubmit;
    }

    function toggleItemSelect() {
        const selectedType = typeSelector.value;

        instrumentSelect.style.display = 'none';
        serviceSelect.style.display = 'none';
        itemDetailLabel.style.display = 'none';

        if (selectedType === 'instrument') {
            instrumentSelect.style.display = 'block';
            itemDetailLabel.style.display = 'block';
        } else if (selectedType === 'service') {
            serviceSelect.style.display = 'block';
            itemDetailLabel.style.display = 'block';
        }
        
        updateSubmitButton();
    }
    
    // ğŸš¨ é—œéµæ­¥é©Ÿï¼šåœ¨è¡¨å–®æäº¤å‰ï¼Œå¼·åˆ¶å°‡é¸ä¸­çš„ ID å¯«å…¥éš±è—æ¬„ä½
    if (reservationForm) {
        reservationForm.addEventListener('submit', function(e) {
            const selection = getSelection();
            
            if (selection.id && selection.type) {
                // å¼·åˆ¶è³¦å€¼ï¼
                forceItemId.value = selection.id; 
                forceItemType.value = selection.type;
            } else {
                // å¦‚æœæ²’æœ‰é¸æ“‡ï¼Œé˜»æ­¢æäº¤
                e.preventDefault(); 
                alert('è«‹é¸æ“‡æ‚¨è¦é ç´„çš„å„€å™¨æˆ–æœå‹™ã€‚');
            }
        });
    }

    // ç›£è½å™¨è¨­ç½®
    typeSelector.addEventListener('change', toggleItemSelect);
    typeSelector.addEventListener('input', toggleItemSelect); 

    instrumentSelect.addEventListener('change', updateSubmitButton);
    serviceSelect.addEventListener('change', updateSubmitButton);

    // åˆå§‹åŒ–é é¢ç‹€æ…‹
    toggleItemSelect();
});
</script>


{% endblock content %}
