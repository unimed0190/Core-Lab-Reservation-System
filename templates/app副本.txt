# app.py 
# ----------------------------------------------------

# å°å…¥æ›´å¤šéœ€è¦çš„å‡½å¼ï¼Œä»¥ä¾¿è™•ç†ç¶²é è«‹æ±‚ã€å°å‘é é¢å’Œé¡¯ç¤ºè¨Šæ¯
from flask import Flask, render_template, request, redirect, url_for, flash 
from flask_sqlalchemy import SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash 
from datetime import datetime, timedelta
from forms import InstrumentForm, RegistrationForm, LoginForm, ReservationForm, UserEditForm, SuperAdminForm, ServiceForm # ğŸš¨ ç¢ºä¿æ‚¨å·²å°‡ SuperAdminForm å°å…¥

# å°å…¥ os æ¨¡çµ„ç”¨æ–¼è·¯å¾‘æ“ä½œ
import os 
# å°å…¥ secure_filename å‡½å¼ï¼Œç”¨æ–¼å®‰å…¨è™•ç†ä¸Šå‚³æª”æ¡ˆåç¨±
from werkzeug.utils import secure_filename

# å°å…¥ Flask-Login ç›¸é—œæ¨¡çµ„
from flask_login import LoginManager, UserMixin, login_user, logout_user, current_user, login_required 

# å„€å™¨è©³æƒ…è·¯ç”±ï¼šè™•ç†é¡¯ç¤ºé é¢ (GET) å’Œé ç´„æäº¤ (POST)

# åˆå§‹åŒ– Flask æ‡‰ç”¨ç¨‹å¼
app = Flask(__name__)


# ====== 1. è³‡æ–™åº«é…ç½® & å®‰å…¨å¯†é‘° (æ›´æ–°éƒ¨åˆ†) ======

# è¨­ç½®æª”æ¡ˆä¸Šå‚³çš„ç›®æ¨™è³‡æ–™å¤¾
UPLOAD_FOLDER = 'static/instrument_images' 
# ç¢ºä¿ Flask çŸ¥é“é€™å€‹è³‡æ–™å¤¾
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
# ç¢ºä¿é€™å€‹è³‡æ–™å¤¾å­˜åœ¨
if not os.path.exists(UPLOAD_FOLDER):
Â  Â  os.makedirs(UPLOAD_FOLDER)

# Flask-WTF éœ€è¦ä¸€å€‹å¯†é‘°ä¾†ä¿è­·æ‚¨çš„è¡¨å–®å®‰å…¨ (é˜²æ­¢ CSRF æ”»æ“Š)
# è«‹å‹™å¿…ä½¿ç”¨ä¸€å€‹è¤‡é›œçš„å¯†é‘°ï¼Œé€™è£¡åƒ…ç‚ºç¯„ä¾‹
app.config['SECRET_KEY'] = 'your_super_secure_key_for_flask_wtf' 
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///reservations.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)

# åˆå§‹åŒ– Flask-Login
login_manager = LoginManager()
login_manager.init_app(app)
# è¨­å®šæœªç™»å…¥æ™‚æœƒè¢«å°å‘çš„å‡½å¼åç¨±
login_manager.login_view = 'login' 

# é€™æ˜¯ Flask-Login ç”¨ä¾†å¾è³‡æ–™åº«è¼‰å…¥ä½¿ç”¨è€…çš„å‡½å¼ (å¿…å‚™ï¼)
@login_manager.user_loader
def load_user(user_id):
Â  Â  # é€™è£¡çš„ user_id æ˜¯å­—ä¸²ï¼Œéœ€è¦è½‰æ›æˆæ•´æ•¸
Â  Â  return User.query.get(int(user_id))
# å„€å™¨åˆ—è¡¨é é¢ (ä¸éœ€ç™»å…¥å³å¯æŸ¥çœ‹)
@app.route('/instruments')
def instruments():
Â  Â  # ğŸŒŸ æŸ¥è©¢è³‡æ–™åº«ï¼šä½¿ç”¨ Instrument.query.all() ç²å–æ‰€æœ‰å„€å™¨
Â  Â  instruments = Instrument.query.all()
Â  Â  
Â  Â  # å°‡æŸ¥è©¢åˆ°çš„å„€å™¨æ¸…å–®å‚³éçµ¦æ¨¡æ¿
Â  Â  return render_template('instruments.html', instruments=instruments)

@login_required
@app.route('/instrument/<int:instrument_id>', methods=['GET', 'POST'])
def instrument_detail(instrument_id):
Â  Â  # 1. ç²å–å„€å™¨ç‰©ä»¶ï¼Œæ‰¾ä¸åˆ°å‰‡è¿”å›404
Â  Â  instrument = Instrument.query.get_or_404(instrument_id)
Â  Â  
Â  Â  # 2. å¯¦ä¾‹åŒ–é ç´„è¡¨å–®
Â  Â  form = ReservationForm()
Â  Â  current_time = datetime.now() 
Â  Â  
Â  Â  # ----------------------------------------------------------------------
Â  Â  # 3. è™•ç†è¡¨å–®æäº¤ (POST è«‹æ±‚) 
Â  Â  # ----------------------------------------------------------------------
Â  Â  if form.validate_on_submit():
Â  Â  Â  Â  start_time = form.start_time.data
Â  Â  Â  Â  end_time = form.end_time.data
Â  Â  Â  Â  
Â  Â  Â  Â  # 3.1. åŸ·è¡Œé ç´„è¡çªæª¢æŸ¥æŸ¥è©¢
Â  Â  Â  Â  conflict_reservations = Reservation.query.filter(
Â  Â  Â  Â  Â  Â  Reservation.instrument_id == instrument.id,
Â  Â  Â  Â  Â  Â  Reservation.status.in_(['confirmed', 'pending']), # æª¢æŸ¥å·²ç¢ºèªå’Œå¾…å¯©æ ¸çš„é ç´„
Â  Â  Â  Â  Â  Â  Reservation.start_time < end_time,
Â  Â  Â  Â  Â  Â  Reservation.end_time > start_time
Â  Â  Â  Â  ).all()
Â  Â  Â  Â  
Â  Â  Â  Â  # 3.2. åˆ¤æ–·æ˜¯å¦æœ‰è¡çª
Â  Â  Â  Â  if conflict_reservations:
Â  Â  Â  Â  Â  Â  # æ‰¾åˆ°è¡çªï¼Œé˜»æ­¢é ç´„ä¸¦é¡¯ç¤ºéŒ¯èª¤
Â  Â  Â  Â  Â  Â  flash('é ç´„å¤±æ•—ï¼šæ‚¨é¸æ“‡çš„æ™‚æ®µèˆ‡ç¾æœ‰é ç´„ç™¼ç”Ÿè¡çªï¼è«‹æª¢æŸ¥æ™‚é–“ã€‚', 'danger')
Â  Â  Â  Â  Â  Â  # ç¨‹å¼ç¢¼å°‡ç¹¼çºŒåŸ·è¡Œåˆ°ä¸‹æ–¹çš„ render_template
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  elif start_time >= end_time:
Â  Â  Â  Â  Â  Â  # æª¢æŸ¥æ™‚é–“é †åº
Â  Â  Â  Â  Â  Â  flash('é ç´„å¤±æ•—ï¼šé–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ã€‚', 'danger')
Â  Â  Â  Â  Â  Â  # ç¨‹å¼ç¢¼å°‡ç¹¼çºŒåŸ·è¡Œåˆ°ä¸‹æ–¹çš„ render_template
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  # 3.3. ç„¡è¡çªä¸”æ™‚é–“æœ‰æ•ˆï¼Œç¹¼çºŒè™•ç†é ç´„å¯«å…¥
Â  Â  Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  Â  Â  new_reservation = Reservation(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  instrument_id=instrument.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id=current_user.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  start_time=start_time,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  end_time=end_time,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  purpose=form.purpose.data,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status='pending'
Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  db.session.add(new_reservation)
Â  Â  Â  Â  Â  Â  Â  Â  db.session.commit()
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  flash('æ‚¨çš„é ç´„å·²æäº¤æˆåŠŸï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ã€‚', 'success')
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  Â  Â  db.session.rollback()
Â  Â  Â  Â  Â  Â  Â  Â  flash(f'é ç´„æäº¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}', 'danger')
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  # 3.4. æäº¤æˆåŠŸå¾Œè·³è½‰ï¼Œé˜²æ­¢äºŒæ¬¡æäº¤
Â  Â  Â  Â  Â  Â  return redirect(url_for('instrument_detail', instrument_id=instrument.id))

Â  Â  
Â  Â  # ----------------------------------------------------------------------
Â  Â  # 4. æº–å‚™æ¸²æŸ“é é¢æ‰€éœ€çš„æ•¸æ“š (ä¸è«–æ˜¯ GET é‚„æ˜¯ POST å¤±æ•—ï¼Œéƒ½æœƒåŸ·è¡Œé€™è£¡)
Â  Â  # ----------------------------------------------------------------------
Â  Â  
Â  Â  # 4.1. è¨­å®šè¡¨å–®é è¨­æ™‚é–“ (åƒ…åœ¨ GET è«‹æ±‚æ™‚è¨­å®šï¼ŒPOST å¤±æ•—æ™‚è¡¨å–®æœƒä¿ç•™æ•¸æ“š)
Â  Â  if request.method == 'GET':
Â  Â  Â  Â  now_clean = current_time.replace(second=0, microsecond=0)
Â  Â  Â  Â  form.start_time.data = now_clean
Â  Â  Â  Â  form.end_time.data = now_clean + timedelta(hours=2)

Â  Â  # 4.2. ç²å–å·²ç¢ºèªä¸”å°šæœªçµæŸçš„é ç´„æ¸…å–® (é€™æ˜¯ä¿®æ­£ UnboundLocalError çš„é—œéµé»)
Â  Â  confirmed_reservations = Reservation.query.filter(
Â  Â  Â  Â  Reservation.instrument_id == instrument.id,
Â  Â  Â  Â  Reservation.status == 'confirmed',
Â  Â  Â  Â  Reservation.end_time >= current_time
Â  Â  ).order_by(Reservation.start_time.asc()).all()

Â  Â  # 5. è¿”å›æ¸²æŸ“çš„æ¨¡æ¿ (é€™æ˜¯å”¯ä¸€ä¸”æ­£ç¢ºçš„ render_template)
Â  Â  return render_template('instrument_detail.html', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â form=form, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â instrument=instrument,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â confirmed_reservations=confirmed_reservations)

# ----------------------------------------------------
# ğŸŒŸ æ–°å¢ï¼šå°ˆæ¡ˆæœå‹™ç›¸é—œè·¯ç”± ğŸŒŸ
# ----------------------------------------------------

# å°ˆæ¡ˆæœå‹™åˆ—è¡¨é é¢ (ä¸éœ€ç™»å…¥å³å¯æŸ¥çœ‹)
@app.route('/services')
def services():
Â  Â  services_list = Service.query.all()
Â  Â  # å‡è¨­æ‚¨æ–°å¢äº† templates/services.html æ¨¡æ¿
Â  Â  return render_template('services.html', services=services_list)

# å°ˆæ¡ˆæœå‹™è©³æƒ…åŠé ç´„è·¯ç”±
@login_required
@app.route('/service/<int:service_id>', methods=['GET', 'POST'])
def service_detail(service_id):
Â  Â  service = Service.query.get_or_404(service_id)
Â  Â  form = ReservationForm()
Â  Â  current_time = datetime.now()

Â  Â  if form.validate_on_submit():
Â  Â  Â  Â  start_time = form.start_time.data
Â  Â  Â  Â  end_time = form.end_time.data

Â  Â  Â  Â  # è¡çªæª¢æŸ¥ (åªæª¢æŸ¥é‡å°æ­¤æœå‹™çš„é ç´„)
Â  Â  Â  Â  conflict_reservations = Reservation.query.filter(
Â  Â  Â  Â  Â  Â  Reservation.service_id == service.id, # ğŸŒŸ é—œéµï¼šæª¢æŸ¥ service_id ğŸŒŸ
Â  Â  Â  Â  Â  Â  Reservation.status.in_(['confirmed', 'pending']),
Â  Â  Â  Â  Â  Â  Reservation.start_time < end_time,
Â  Â  Â  Â  Â  Â  Reservation.end_time > start_time
Â  Â  Â  Â  ).all()

Â  Â  Â  Â  if conflict_reservations:
Â  Â  Â  Â  Â  Â  flash('é ç´„å¤±æ•—ï¼šæ‚¨é¸æ“‡çš„æ™‚æ®µèˆ‡ç¾æœ‰é ç´„ç™¼ç”Ÿè¡çªï¼', 'danger')
Â  Â  Â  Â  elif start_time >= end_time:
Â  Â  Â  Â  Â  Â  flash('é ç´„å¤±æ•—ï¼šé–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ã€‚', 'danger')
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  Â  Â  new_reservation = Reservation(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  service_id=service.id, Â # ğŸŒŸ å¯«å…¥ service_id ğŸŒŸ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id=current_user.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  start_time=start_time,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  end_time=end_time,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  purpose=form.purpose.data,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status='pending'
Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  # åŸ·è¡Œè‡ªè¨‚æª¢æŸ¥ (ç¢ºä¿åªé€£çµä¸€å€‹é …ç›®)
Â  Â  Â  Â  Â  Â  Â  Â  if not new_reservation.is_valid():
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  raise ValueError("é ç´„è¨˜éŒ„å¿…é ˆä¸”åªèƒ½é€£çµåˆ°ä¸€å€‹æœå‹™æˆ–å„€å™¨ã€‚")

Â  Â  Â  Â  Â  Â  Â  Â  db.session.add(new_reservation)
Â  Â  Â  Â  Â  Â  Â  Â  db.session.commit()
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  flash('æ‚¨çš„å°ˆæ¡ˆæœå‹™é ç´„å·²æäº¤æˆåŠŸï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ã€‚', 'success')
Â  Â  Â  Â  Â  Â  Â  Â  return redirect(url_for('service_detail', service_id=service.id))
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  Â  Â  db.session.rollback()
Â  Â  Â  Â  Â  Â  Â  Â  flash(f'é ç´„æäº¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}', 'danger')
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  
Â  Â  # 4. æº–å‚™æ¸²æŸ“é é¢æ‰€éœ€çš„æ•¸æ“š (GET æˆ– POST å¤±æ•—)
Â  Â  if request.method == 'GET':
Â  Â  Â  Â  now_clean = current_time.replace(second=0, microsecond=0)
Â  Â  Â  Â  form.start_time.data = now_clean
Â  Â  Â  Â  form.end_time.data = now_clean + timedelta(hours=2)

Â  Â  # ç²å–å·²ç¢ºèªä¸”å°šæœªçµæŸçš„å°ˆæ¡ˆæœå‹™é ç´„æ¸…å–®
Â  Â  confirmed_reservations = Reservation.query.filter(
Â  Â  Â  Â  Reservation.service_id == service.id, # ğŸŒŸ é—œéµï¼šæª¢æŸ¥ service_id ğŸŒŸ
Â  Â  Â  Â  Reservation.status == 'confirmed',
Â  Â  Â  Â  Reservation.end_time >= current_time
Â  Â  ).order_by(Reservation.start_time.asc()).all()

Â  Â  # å‡è¨­æ‚¨æ–°å¢äº† templates/service_detail.html æ¨¡æ¿
Â  Â  return render_template('service_detail.html', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â form=form, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â service=service,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â confirmed_reservations=confirmed_reservations)

# ====== 2. å„€å™¨æ¨¡å‹å®šç¾© (Instrument Model) ======
class Instrument(db.Model):
Â  Â  id = db.Column(db.Integer, primary_key=True)
Â  Â  instrument_code = db.Column(db.String(100), unique=True, nullable=False)
Â  Â  chinese_name = db.Column(db.String(100), nullable=False) 
Â  Â  english_name = db.Column(db.String(100), nullable=False) 
Â  Â  description = db.Column(db.Text) 
Â  Â  image_url = db.Column(db.String(255)) 
Â  Â  
Â  Â  # å»ºç«‹ä¸€å€‹åå‘é—œä¿‚ (Back-reference)ï¼šè®“å„€å™¨ç‰©ä»¶çŸ¥é“å®ƒæœ‰å“ªäº›é ç´„ç´€éŒ„
Â  Â  reservations = db.relationship('Reservation', backref='instrument', lazy=True)

Â  Â  def __repr__(self):
Â  Â  Â  Â  return f'<Instrument {self.chinese_name}>'

# ====== 3. ä½¿ç”¨è€…æ¨¡å‹å®šç¾© (User Model) ======
# User é¡åˆ¥ç¾åœ¨ç¹¼æ‰¿ db.Model å’Œ UserMixin
class User(UserMixin, db.Model):
Â  Â  id = db.Column(db.Integer, primary_key=True)
Â  Â  email = db.Column(db.String(120), unique=True, nullable=False)
Â  Â  password_hash = db.Column(db.String(128))
Â  Â  role = db.Column(db.String(20), default='researcher', nullable=False) # 'admin' æˆ– 'researcher'
Â  Â  full_name = db.Column(db.String(100), nullable=False) 
Â  Â  affiliation = db.Column(db.String(100))
Â  Â  unit = db.Column(db.String(100))
Â  Â  phone_number = db.Column(db.String(20))
Â  Â  
Â  Â  # å»ºç«‹ä¸€å€‹åå‘é—œä¿‚ï¼šè®“ä½¿ç”¨è€…ç‰©ä»¶çŸ¥é“ä»–åšäº†å“ªäº›é ç´„
Â  Â  reservations = db.relationship('Reservation', backref='user', lazy=True, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â cascade="all, delete-orphan")

Â  Â  def set_password(self, password):
Â  Â  Â  Â  self.password_hash = generate_password_hash(password)

Â  Â  def check_password(self, password):
Â  Â  Â  Â  return check_password_hash(self.password_hash, password)

Â  Â  def __repr__(self):
Â  Â  Â  Â  return f'<User {self.full_name} ({self.role})>'

# ====== 4. é ç´„æ¨¡å‹å®šç¾© (Reservation Model - æ–°å¢éƒ¨åˆ†) ======
# ç”±æ–¼ Reservation æ¨¡å‹éœ€è¦èƒ½é€£çµåˆ° Instrument æˆ– Serviceï¼Œ
# æˆ‘å€‘éœ€è¦æ›´æ–° Reservation æ¨¡å‹ï¼Œè®“å®ƒå¯ä»¥åŒæ™‚é€£çµé€™å…©å€‹é …ç›®ï¼Œä½†åªèƒ½é¸ä¸€å€‹ã€‚

# ğŸš¨ ä¿®æ­£ Reservation æ¨¡å‹ï¼Œä½¿å…¶èƒ½åŒæ™‚æ”¯æ´ Instrument å’Œ Service
class Reservation(db.Model):
Â  Â  id = db.Column(db.Integer, primary_key=True)
Â  Â  
Â  Â  # å¤–ä¾†éµï¼šé€£çµåˆ° Instrument.id (å¯ç‚ºç©º)
Â  Â  instrument_id = db.Column(db.Integer, db.ForeignKey('instrument.id'), nullable=True) # æ”¹ç‚º nullable=True
Â  Â  
Â  Â  # æ–°å¢å¤–ä¾†éµï¼šé€£çµåˆ° Service.id (å¯ç‚ºç©º)
Â  Â  service_id = db.Column(db.Integer, db.ForeignKey('service.id'), nullable=True) # æ–°å¢æ¬„ä½
Â  Â  
Â  Â  # å¤–ä¾†éµï¼šé€£çµåˆ° User.id
Â  Â  user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
Â  Â  
Â  Â  # é ç´„é–‹å§‹èˆ‡çµæŸæ™‚é–“
Â  Â  start_time = db.Column(db.DateTime, nullable=False)
Â  Â  end_time = db.Column(db.DateTime, nullable=False)
Â  Â  
Â  Â  # é ç´„ç›®çš„
Â  Â  purpose = db.Column(db.Text)
Â  Â  
Â  Â  # ç‹€æ…‹ï¼šé è¨­ç‚ºå¾…å¯©æ ¸
Â  Â  status = db.Column(db.String(20), default='pending', nullable=False) 
Â  Â  
Â  Â  # ç´€éŒ„å»ºç«‹æ™‚é–“ï¼šä½¿ç”¨ default=datetime.utcnow æœƒåœ¨ç´€éŒ„å»ºç«‹æ™‚è‡ªå‹•å¯«å…¥ç•¶å‰æ™‚é–“
Â  Â  created_at = db.Column(db.DateTime, default=datetime.utcnow) 

Â  Â  # ğŸŒŸ ç¢ºä¿é ç´„åªå±¬æ–¼ä¸€é …ï¼šæª¢æŸ¥ç´„æŸ (åœ¨å¯«å…¥è³‡æ–™åº«å‰è¦æ‰‹å‹•æª¢æŸ¥)
Â  Â  def is_valid(self):
Â  Â  Â  Â  # ç¢ºä¿ instrument_id å’Œ service_id å…©è€…ä¸éƒ½ç‚ºç©ºï¼Œä¸”ä¸éƒ½éç©º
Â  Â  Â  Â  if (self.instrument_id is None and self.service_id is None) or \
Â  Â  Â  Â  Â  Â (self.instrument_id is not None and self.service_id is not None):
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  return True

Â  Â  def __repr__(self):
Â  Â  Â  Â  return f'<Reservation ID:{self.id} for Instrument:{self.instrument_id} by User:{self.user_id}>'

# ====== 5. å°ˆæ¡ˆæœå‹™æ¨¡å‹å®šç¾© (Service Model - æ–°å¢) ======
class Service(db.Model):
Â  Â  id = db.Column(db.Integer, primary_key=True)
Â  Â  # ğŸš¨ ä¿®æ­£ 1: å°ˆæ¡ˆä»£ç¢¼ (Service Code) æ¬„ä½
Â  Â  service_code = db.Column(db.String(100), unique=True, nullable=False) 
Â  Â  
Â  Â  chinese_name = db.Column(db.String(100), nullable=False)
Â  Â  # ğŸš¨ ä¿®æ­£ 2: ç¼ºå°‘ English Name æ¬„ä½ (ServiceForm ä¸­æœ‰ï¼Œå› æ­¤æ¨¡å‹ä¹Ÿå¿…é ˆæœ‰)
Â  Â  english_name = db.Column(db.String(100)) # å‡è¨­ä¸éœ€è¦åƒä»£ç¢¼é‚£æ¨£ unique
Â  Â  
Â  Â  description = db.Column(db.Text)
Â  Â  # ğŸš¨ ä¿®æ­£ 3: åœ–ç‰‡ URL æ¬„ä½ (ServiceForm ä¸­æœ‰ï¼Œå› æ­¤æ¨¡å‹ä¹Ÿå¿…é ˆæœ‰)
Â  Â  image_url = db.Column(db.String(255)) 
Â  Â  
Â  Â  # å»ºç«‹ä¸€å€‹åå‘é—œä¿‚ï¼šè®“æœå‹™ç‰©ä»¶çŸ¥é“å®ƒæœ‰å“ªäº›é ç´„ç´€éŒ„
Â  Â  service_reservations = db.relationship('Reservation', backref='service', lazy=True)

Â  Â  def __repr__(self):
Â  Â  Â  Â  return f'<Service {self.chinese_name}>'

# ====== 6. ç¶²ç«™è·¯ç”± (Routes) ======

@app.route('/')
def index(): # ğŸ‘ˆ é—œéµï¼šé€™å€‹å‡½å¼åç¨±å¿…é ˆæ˜¯ 'index'
Â  Â  # æˆ‘å€‘ä¹Ÿéœ€è¦è¨­å®šè®“é¦–é èƒ½å¤ é¡¯ç¤ºå¿«é–ƒè¨Šæ¯ï¼Œæ‰€ä»¥æ”¹ç”¨æ¨¡æ¿
Â  Â  return render_template('base.html', title='å„€å™¨èˆ‡å°ˆæ¡ˆæœå‹™é ç´„ç³»çµ±')

# ç¢ºä¿ä½¿ç”¨è€…å¿…é ˆç™»å…¥æ‰èƒ½è¨ªå•é€™å€‹é é¢
@login_required
@app.route('/admin/add_instrument', methods=['GET', 'POST'])
def add_instrument():

    # ğŸŒŸ è§’è‰²æª¢æŸ¥é–‹å§‹ ğŸŒŸ
    allowed_roles = ['admin', 'super_admin']
    if current_user.role not in allowed_roles:
        flash('æ¬Šé™ä¸è¶³ï¼æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤ç®¡ç†é é¢ã€‚', 'danger')
        return redirect(url_for('index'))
    # ğŸŒŸ è§’è‰²æª¢æŸ¥çµæŸ ğŸŒŸ

    # åªæœ‰ admin è§’è‰²æ‰èƒ½åŸ·è¡Œä¸‹é¢çš„ç¨‹å¼ç¢¼
    # ğŸŒŸ æ­¥é©Ÿ 1: å‰µå»ºè¡¨å–®å¯¦ä¾‹ (é€™è¡Œå¿…é ˆåœ¨æœ€å‰é¢)
    form = InstrumentForm() 

    # æª¢æŸ¥æ˜¯å¦ç‚º POST æäº¤ä¸”è³‡æ–™æœ‰æ•ˆ
    if form.validate_on_submit():

        image_filename = None
        # ğŸš¨ é—œéµï¼šè™•ç†æª”æ¡ˆä¸Šå‚³
        if form.image_file.data:
            # ç²å–ä¸Šå‚³çš„æª”æ¡ˆ

            # ç¢ºä¿æª”æ¡ˆåç¨±å®‰å…¨
            filename = secure_filename(uploaded_file.filename)

            # çµ„åˆå®Œæ•´çš„å„²å­˜è·¯å¾‘
            filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)

            # å„²å­˜æª”æ¡ˆåˆ°ä¼ºæœå™¨
            uploaded_file.save(filepath)

            # ğŸŒŸ å„²å­˜æª”æ¡ˆçš„ç›¸å°è·¯å¾‘åˆ°è³‡æ–™åº« (ä½¿ç”¨ç›¸å°è·¯å¾‘æ–¹ä¾¿åœ¨ HTML ä¸­é¡¯ç¤º)
            image_filename = os.path.join('instrument_images', filename)

        # 1. å–å¾—è¡¨å–®è³‡æ–™
        new_instrument = Instrument(
            chinese_name=form.chinese_name.data,
            english_name=form.english_name.data,
        description=form.description.data,
image_url=image_filename # å¯«å…¥æª”æ¡ˆè·¯å¾‘ (e.g. 'instrument_images/my_file.jpg')
        )

        # 2. å°‡è³‡æ–™å¯«å…¥è³‡æ–™åº«
        db.session.add(new_instrument)
        db.session.commit()

        # 3. çµ¦äºˆæˆåŠŸè¨Šæ¯æç¤º
        flash(f'å„€å™¨ "{new_instrument.chinese_name}" å·²æˆåŠŸæ–°å¢ï¼', 'success')

        # ğŸŒŸ ä¿®æ­£é»ï¼šå¿…é ˆä½¿ç”¨ new_instrument.id ğŸŒŸ
        return redirect(url_for('instrument_detail', instrument_id=new_instrument.id))

    # ğŸŒŸ æ­¥é©Ÿ 2: å¦‚æœæ˜¯ GET è«‹æ±‚ï¼Œæˆ– POST é©—è­‰å¤±æ•—ï¼Œå°±åŸ·è¡Œé€™è¡Œ
    # é€™ç¢ºä¿äº† 'form' æ°¸é æœƒè¢«å‚³éçµ¦æ¨¡æ¿s83
return render_template('add_instrument.html', form=form)

# ----------------------------------------------------
# ğŸŒŸ æ–°å¢ï¼šç®¡ç†å“¡æ–°å¢å°ˆæ¡ˆæœå‹™ ğŸŒŸ
# ----------------------------------------------------

@login_required
@app.route('/admin/add_service', methods=['GET', 'POST'])
def add_service():
Â  Â  # 1. æ¬Šé™æª¢æŸ¥ï¼šåªæœ‰ admin æˆ– super_admin æ‰èƒ½è¨ªå•
Â  Â  allowed_roles = ['admin', 'super_admin']
Â  Â  if current_user.role not in allowed_roles:
Â  Â  Â  Â  flash('æ¬Šé™ä¸è¶³ï¼æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤ç®¡ç†é é¢ã€‚', 'danger')
Â  Â  Â  Â  return redirect(url_for('index'))
Â  Â  Â  Â  
Â  Â  # 2. å‰µå»ºè¡¨å–®å¯¦ä¾‹
Â  Â  form = ServiceForm() 
Â  Â  
Â  Â  if form.validate_on_submit():
Â  Â  Â  Â  # ğŸš¨ ä¿®æ­£ 1: ä¿®æ­£æ‹¼å¯«éŒ¯èª¤ 'Noene' ç‚º None
Â  Â  Â  Â  image_filename = None

Â  Â  Â  Â  # ğŸš¨ ä¿®æ­£ 2: è£œå›æª”æ¡ˆä¸Šå‚³è™•ç† (å¦‚æœæ‚¨çš„ ServiceForm æœ‰ image_file æ¬„ä½)
Â  Â  Â  Â  if hasattr(form, 'image_file') and form.image_file.data:
Â  Â  Â  Â  Â  Â  uploaded_file = form.image_file.data
Â  Â  Â  Â  Â  Â  filename = secure_filename(uploaded_file.filename)
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  # ğŸ’¡ å»ºè­°ï¼šå°‡æœå‹™åœ–ç‰‡å­˜å…¥ service_images è³‡æ–™å¤¾ä»¥å€åˆ†
Â  Â  Â  Â  Â  Â  SERVICE_UPLOAD_FOLDER = 'static/service_images'
Â  Â  Â  Â  Â  Â  if not os.path.exists(SERVICE_UPLOAD_FOLDER):
Â  Â  Â  Â  Â  Â  Â  Â  os.makedirs(SERVICE_UPLOAD_FOLDER)
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  filepath = os.path.join(SERVICE_UPLOAD_FOLDER, filename)
Â  Â  Â  Â  Â  Â  uploaded_file.save(filepath)
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  # å„²å­˜ç›¸å°è·¯å¾‘
Â  Â  Â  Â  Â  Â  image_filename = os.path.join('service_images', filename) 


Â  Â  Â  Â  # 3. å‰µå»º Service ç‰©ä»¶
Â  Â  Â  Â  # ğŸš¨ ä¿®æ­£ 3: ç¢ºä¿å‚³éæ‰€æœ‰éœ€è¦çš„æ¬„ä½ï¼Œä¾‹å¦‚ service_code, image_url
Â  Â  Â  Â  new_service = Service(
Â  Â  Â  Â  Â  Â  # ç¢ºä¿ Service æ¨¡å‹æœ‰é€™å€‹æ¬„ä½
Â  Â  Â  Â  Â  Â  service_code=form.service_code.data, 
Â  Â  Â  Â  Â  Â  chinese_name=form.chinese_name.data,
Â  Â  Â  Â  Â  Â  english_name=form.english_name.data,
Â  Â  Â  Â  Â  Â  description=form.description.data,
Â  Â  Â  Â  Â  Â  image_url=image_filename # å¯«å…¥åœ–ç‰‡è·¯å¾‘ï¼Œå¦‚æœæ²’æœ‰ä¸Šå‚³ï¼Œå‰‡ç‚º None
Â  Â  Â  Â  )

Â  Â  Â  Â  # 4. å¯«å…¥è³‡æ–™åº« - ä½¿ç”¨ try...except è™•ç†æ½›åœ¨éŒ¯èª¤ (å¦‚ service_code é‡è¤‡)
Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  db.session.add(new_service)
Â  Â  Â  Â  Â  Â  db.session.commit()

Â  Â  Â  Â  Â  Â  # 5. æç¤ºä¸¦å°å‘
Â  Â  Â  Â  Â  Â  flash(f'å°ˆæ¡ˆæœå‹™ "{new_service.chinese_name}" å·²æˆåŠŸæ–°å¢ï¼', 'success')
Â  Â  Â  Â  Â  Â  # ğŸŒŸ å°å‘åˆ°æœå‹™è©³æƒ…é é¢
Â  Â  Â  Â  Â  Â  return redirect(url_for('service_detail', service_id=new_service.id))

Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  db.session.rollback()
Â  Â  Â  Â  Â  Â  # ğŸŒŸ å¢åŠ éŒ¯èª¤æç¤ºï¼šå¯èƒ½æ˜¯ service_code é‡è¤‡å°è‡´çš„ IntegrityError
Â  Â  Â  Â  Â  Â  flash(f'æ–°å¢å°ˆæ¡ˆæœå‹™å¤±æ•—ï¼šä»£ç¢¼é‡è¤‡æˆ–è³‡æ–™åº«éŒ¯èª¤ã€‚è«‹æª¢æŸ¥è¼¸å…¥ã€‚éŒ¯èª¤ï¼š{e}', 'danger')
Â  Â  Â  Â  Â  Â  # ğŸŒŸ å¤±æ•—æ™‚ï¼Œè¿”å›åˆ°è¡¨å–®é é¢
Â  Â  Â  Â  Â  Â  return render_template('add_service.html', form=form)
Â  Â  Â  Â  Â  Â  
Â  Â  # 6. æ¸²æŸ“æ¨¡æ¿ (GET è«‹æ±‚æˆ– POST å¤±æ•—)
Â  Â  return render_template('add_service.html', form=form)

@login_required 
@app.route('/admin/reservations')
def admin_reservations():
Â  Â  # 1. æ¬Šé™æª¢æŸ¥ï¼šåªæœ‰ admin æ‰èƒ½è¨ªå•
Â  Â  allowed_roles = ['admin', 'super_admin']
Â  Â  if current_user.role not in allowed_roles:
Â  Â  Â  Â  flash('æ¬Šé™ä¸è¶³ï¼æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤ç®¡ç†é é¢ã€‚', 'danger')
Â  Â  Â  Â  return redirect(url_for('index'))
Â  Â  Â  Â  
Â  Â  # 2. æŸ¥è©¢è³‡æ–™åº«ï¼šç²å–æ‰€æœ‰ç‹€æ…‹ç‚º 'pending' çš„é ç´„ç´€éŒ„
Â  Â  # ğŸŒŸ ä½¿ç”¨ filter_by ç¯©é¸å‡º instrument_id å’Œ status
Â  Â  pending_reservations = Reservation.query.filter_by(
Â  Â  Â  Â  status='pending'
Â  Â  ).order_by(Reservation.created_at.asc()).all() # æŒ‰ç…§å»ºç«‹æ™‚é–“å‡åºæ’åˆ—
Â  Â  
Â  Â  # 3. æ¸²æŸ“æ¨¡æ¿
Â  Â  return render_template('admin_reservations.html', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pending_reservations=pending_reservations)

@login_required
# ğŸŒŸ ä¿®æ­£é»ï¼šæ˜ç¢ºæŒ‡å®šåªæ¥å— POST è«‹æ±‚ (èˆ‡ HTML æ¨¡æ¿é…åˆ) ğŸŒŸ
@app.route('/admin/approve/<int:reservation_id>', methods=['POST'])
def approve_reservation(reservation_id):
Â  Â  # 1. æ¬Šé™æª¢æŸ¥ï¼šç¢ºä¿æ˜¯ Admin æˆ– Super Admin
Â  Â  allowed_roles = ['admin', 'super_admin']
Â  Â  if current_user.role not in allowed_roles:
Â  Â  Â  Â  flash('æ¬Šé™ä¸è¶³ï¼', 'danger')
Â  Â  Â  Â  return redirect(url_for('index'))
Â  Â  
Â  Â  # 2. æŸ¥è©¢è©²é ç´„ç´€éŒ„
Â  Â  reservation = Reservation.query.get_or_404(reservation_id)
Â  Â  
Â  Â  # 3. æª¢æŸ¥è¡çª (é‡è¦ï¼åœ¨æ‰¹å‡†å‰éœ€è¦å†æ¬¡æª¢æŸ¥)
Â  Â  # è™•ç†å„€å™¨é ç´„çš„è¡çªæª¢æŸ¥
Â  Â  if reservation.instrument_id:
Â  Â  Â  Â  conflict = Reservation.query.filter(
Â  Â  Â  Â  Â  Â  Reservation.id != reservation_id,
Â  Â  Â  Â  Â  Â  Reservation.instrument_id == reservation.instrument_id,
Â  Â  Â  Â  Â  Â  Reservation.status == 'confirmed',
Â  Â  Â  Â  Â  Â  Reservation.start_time < reservation.end_time,
Â  Â  Â  Â  Â  Â  Reservation.end_time > reservation.start_time
Â  Â  Â  Â  ).first()
Â  Â  # è™•ç†æœå‹™é ç´„çš„è¡çªæª¢æŸ¥
Â  Â  elif reservation.service_id:
Â  Â  Â  Â  conflict = Reservation.query.filter(
Â  Â  Â  Â  Â  Â  Reservation.id != reservation_id,
Â  Â  Â  Â  Â  Â  Reservation.service_id == reservation.service_id,
Â  Â  Â  Â  Â  Â  Reservation.status == 'confirmed',
Â  Â  Â  Â  Â  Â  Reservation.start_time < reservation.end_time,
Â  Â  Â  Â  Â  Â  Reservation.end_time > reservation.start_time
Â  Â  Â  Â  ).first()
Â  Â  else:
Â  Â  Â  Â  # å¦‚æœæ—¢æ²’æœ‰ instrument_id ä¹Ÿæ²’æœ‰ service_id (é‚è¼¯éŒ¯èª¤ï¼Œä½†åœ¨é€™è£¡è™•ç†ä»¥é˜²è¬ä¸€)
Â  Â  Â  Â  conflict = True 

Â  Â  if conflict:
Â  Â  Â  Â  Â  # ç™¼ç¾è¡çªï¼Œæ‹’çµ•æ‰¹å‡†
Â  Â  Â  Â  flash(f'æ‰¹å‡†å¤±æ•—ï¼šé ç´„ ID {reservation_id} èˆ‡å…¶ä»–å·²ç¢ºèªé ç´„è¡çªï¼', 'danger')
Â  Â  Â  Â  return redirect(url_for('admin_reservations'))
Â  Â  
Â  Â  # 4. ç„¡è¡çªï¼Œæ›´æ–°ç‹€æ…‹ç‚º 'confirmed'
Â  Â  reservation.status = 'confirmed'
Â  Â  db.session.commit()
Â  Â  
Â  Â  flash(f'é ç´„ ID {reservation_id} å·²æˆåŠŸæ‰¹å‡†ï¼', 'success')
Â  Â  return redirect(url_for('admin_reservations'))

@login_required
# ğŸŒŸ ä¿®æ­£é»ï¼šæ˜ç¢ºæŒ‡å®šåªæ¥å— POST è«‹æ±‚ (èˆ‡ HTML æ¨¡æ¿é…åˆ) ğŸŒŸ
@app.route('/admin/reject/<int:reservation_id>', methods=['POST'])
def reject_reservation(reservation_id):
Â  Â  Â  # 1. æ¬Šé™æª¢æŸ¥ï¼šç¢ºä¿æ˜¯ Admin æˆ– Super Admin
Â  Â  allowed_roles = ['admin', 'super_admin']
Â  Â  if current_user.role not in allowed_roles:
Â  Â  Â  Â  flash('æ¬Šé™ä¸è¶³ï¼', 'danger')
Â  Â  Â  Â  return redirect(url_for('index'))
Â  Â  
Â  Â  Â  # 2. æŸ¥è©¢è©²é ç´„ç´€éŒ„
Â  Â  reservation = Reservation.query.get_or_404(reservation_id)
Â  Â  
Â  Â  # 3. æ›´æ–°ç‹€æ…‹ç‚º 'rejected'
Â  Â  reservation.status = 'rejected'
Â  Â  db.session.commit()

Â  Â  flash(f'é ç´„ ID {reservation_id} å·²æˆåŠŸæ‹’çµ•ï¼', 'info')
Â  Â  return redirect(url_for('admin_reservations'))

#ç®¡ç†ç ”ç©¶å“¡è·¯ç”±

@login_required
@app.route('/admin/researchers')
def admin_researchers():
    # æ¬Šé™æª¢æŸ¥ï¼šAdmin å’Œ Super Admin éƒ½å¯ä»¥çœ‹
    allowed_roles = ['admin', 'super_admin']
    if current_user.role not in allowed_roles:
        flash('æ¬Šé™ä¸è¶³ï¼', 'danger')
        return redirect(url_for('index'))

    # ğŸŒŸ ç¯©é¸é‚è¼¯ï¼šåªæŸ¥è©¢ role='user' çš„ä½¿ç”¨è€… ğŸŒŸ
    all_users = User.query.filter_by(role='user').all()

    # æ³¨æ„ï¼šæˆ‘å€‘å°‡ä½¿ç”¨æ–°çš„æ¨¡æ¿ admin_researchers.html
    return render_template('admin_researchers.html', 
                            title='ç®¡ç†ç ”ç©¶å“¡', 
                            all_users=all_users)

#ç®¡ç†ç®¡ç†å“¡è·¯ç”±

@login_required
@app.route('/admin/admins')
def admin_admins():
    # æ¬Šé™æª¢æŸ¥ï¼šAdmin å’Œ Super Admin éƒ½å¯ä»¥çœ‹
    allowed_roles = ['admin', 'super_admin']
    if current_user.role not in allowed_roles:
        flash('æ¬Šé™ä¸è¶³ï¼', 'danger')
        return redirect(url_for('index'))

    # ğŸŒŸ ç¯©é¸é‚è¼¯ï¼šæŸ¥è©¢ role åœ¨ ['admin', 'super_admin'] ä¸­çš„ä½¿ç”¨è€… ğŸŒŸ
    allowed_admin_roles = ['admin', 'super_admin']
    all_users = User.query.filter(User.role.in_(allowed_admin_roles)).all()

    # æ³¨æ„ï¼šæˆ‘å€‘å°‡ä½¿ç”¨æ–°çš„æ¨¡æ¿ admin_admins.html
    return render_template('admin_admins.html', 
                            title='ç®¡ç†ç®¡ç†å“¡', 
                            all_users=all_users)

#æ¬Šé™æå‡è·¯ç”± (User -> Admin)

@login_required 
@app.route('/admin/promote/<int:user_id>')
def promote_user(user_id):
    # 1. æ¬Šé™æª¢æŸ¥ï¼šç¢ºä¿æ˜¯ Admin
    if current_user.role != 'super_admin':
        flash('æ¬Šé™ä¸è¶³ï¼åªæœ‰ç¸½ç®¡ç†å“¡æ‰èƒ½æå‡å…¶ä»–ä½¿ç”¨è€…ç‚º Adminã€‚', 'danger')
        return redirect(url_for('admin_researchers')) # å°å‘å›ä½¿ç”¨è€…åˆ—è¡¨

    # 2. æŸ¥è©¢è©²ä½¿ç”¨è€…ç´€éŒ„
    user_to_promote = User.query.get_or_404(user_id)

    # 3. æª¢æŸ¥ï¼šé˜²æ­¢ Admin è‡ªå·±æå‡è‡ªå·±ï¼ˆé›–ç„¶ç„¡æ„ç¾©ï¼Œä½†å®‰å…¨èµ·è¦‹ï¼‰
    if user_to_promote.role == 'admin':
        flash(f'ä½¿ç”¨è€… {user_to_promote.email} å·²ç¶“æ˜¯ Admin è§’è‰²ã€‚', 'info')
        return redirect(url_for('admin_researchers'))

    # 4. æ›´æ–°ç‹€æ…‹ç‚º 'admin'
    user_to_promote.role = 'admin'
    db.session.commit() # ğŸŒŸ æäº¤è®Šæ›´åˆ°è³‡æ–™åº« ğŸŒŸ

    flash(f'ä½¿ç”¨è€… {user_to_promote.email} å·²æˆåŠŸæå‡ç‚º Admin è§’è‰²ï¼', 'success')
    return redirect(url_for('admin_researchers'))

#ç·¨è¼¯ä½¿ç”¨è€…è³‡æ–™ (Edit User Route)

# å°å…¥ UserEditForm (å‡è¨­æ‚¨åœ¨ forms.py ä¸­å®šç¾©äº†æ­¤è¡¨å–®)
# ç¢ºä¿æ‚¨å·²ç¶“åœ¨ forms.py ä¸­å®šç¾©äº† UserEditForm
# ç·¨è¼¯ä½¿ç”¨è€…è·¯ç”± (ä¾› Super Admin ä½¿ç”¨)
@login_required
@app.route('/admin/user/edit/<int:user_id>', methods=['GET', 'POST'])
def edit_user(user_id):
    # 1. æ¬Šé™æª¢æŸ¥ï¼šåªæœ‰ Super Admin æ‰èƒ½ç·¨è¼¯ä½¿ç”¨è€…
    if current_user.role != 'super_admin':
        flash('æ¬Šé™ä¸è¶³ï¼åªæœ‰ç¸½ç®¡ç†å“¡æ‰èƒ½ç·¨è¼¯ä½¿ç”¨è€…è³‡æ–™æˆ–é‡è¨­å¯†ç¢¼ã€‚', 'danger')
        # æ ¹æ“šç”¨æˆ¶è§’è‰²ï¼Œå°å‘æ­£ç¢ºçš„åˆ—è¡¨é é¢
        if User.query.get(user_id) and User.query.get(user_id).role == 'user':
            return redirect(url_for('admin_researchers'))
        else:
            return redirect(url_for('admin_admins'))

    # 2. ç²å–è¦ç·¨è¼¯çš„ä½¿ç”¨è€…ç‰©ä»¶
    user_to_edit = User.query.get_or_404(user_id)
    form = UserEditForm(obj=user_to_edit) # å°‡ç¾æœ‰è³‡æ–™è¼‰å…¥åˆ°è¡¨å–®ä¸­

    if form.validate_on_submit():
        # A. è™•ç†åŸºæœ¬è³‡æ–™æ›´æ–°
        user_to_edit.full_name = form.full_name.data
        user_to_edit.affiliation = form.affiliation.data
        if hasattr(form, 'phone_number'): # æª¢æŸ¥è¡¨å–®æ˜¯å¦æœ‰æ­¤æ¬„ä½ (å¦‚æœ forms.py æœ‰å®šç¾©)
        user_to_edit.phone_number = form.phone_number.data

    # B. è™•ç†å¯†ç¢¼é‡è¨­ (é¸å¡«)
        if form.new_password.data:
            # ç”±æ–¼å¯†ç¢¼é‡è¨­åœ¨è¡¨å–®é©—è­‰æ™‚ï¼ˆconfirmpassword æ¬„ä½ï¼‰å·²ç¶“æª¢æŸ¥éå…©æ¬¡è¼¸å…¥æ˜¯å¦ä¸€è‡´
            # é€™è£¡ç›´æ¥è¨­å®šæ–°å¯†ç¢¼
            user_to_edit.set_password(form.new_password.data)
            flash('å¯†ç¢¼å·²æˆåŠŸé‡è¨­ã€‚', 'success')

        # C. æäº¤è®Šæ›´
        db.session.commit()
        flash(f'ä½¿ç”¨è€… {user_to_edit.email} çš„è³‡æ–™å·²æˆåŠŸæ›´æ–°ã€‚', 'success')

        # D. å°å‘å›æ­£ç¢ºçš„åˆ—è¡¨é é¢
        if user_to_edit.role == 'user':
            return redirect(url_for('admin_researchers'))
        else:
             return redirect(url_for('admin_admins'))

    # 3. æ¸²æŸ“æ¨¡æ¿ (GET è«‹æ±‚æˆ–è¡¨å–®é©—è­‰å¤±æ•—)
    # å‚³å…¥ user ç‰©ä»¶ä»¥ä¾¿æ¨¡æ¿ä¸­é¡¯ç¤ºåªè®€çš„ email/role
    return render_template('edit_user.html', 
                            title='ç·¨è¼¯ä½¿ç”¨è€…è³‡æ–™', 
                            form=form, 
                            user=user_to_edit)

#æ¬Šé™ç§»é™¤è·¯ç”± (Admin -> User)

@login_required 
@app.route('/admin/demote/<int:user_id>')
def demote_user(user_id):
    # 1. æ¬Šé™æª¢æŸ¥ï¼šåªå…è¨± Super Admin è¨ªå•
    if current_user.role != 'super_admin':
        flash('æ¬Šé™ä¸è¶³ï¼åªæœ‰ç¸½ç®¡ç†å“¡æ‰èƒ½è®Šæ›´ç®¡ç†å“¡æ¬Šé™ã€‚', 'danger')
        return redirect(url_for('admin_admins'))

    user_to_demote = User.query.get_or_404(user_id)

    # 2. é˜²è­·æª¢æŸ¥ï¼šä¸å¯ç§»é™¤è‡ªå·±çš„æ¬Šé™ (Super Adminä¸èƒ½é™ç´šè‡ªå·±)
    if user_to_demote.id == current_user.id:
        flash('æ‚¨ä¸èƒ½ç§»é™¤è‡ªå·±çš„æ¬Šé™ï¼', 'danger')
        return redirect(url_for('admin_admins'))

    # 3. é‚è¼¯ Aï¼šå°‡ Super Admin é™ç´šç‚º Admin
    if user_to_demote.role == 'super_admin':
        user_to_demote.role = 'admin'
        db.session.commit() # ğŸŒŸ å¯«å…¥è³‡æ–™åº« ğŸŒŸ
        flash(f'ä½¿ç”¨è€… {user_to_demote.email} å·²é™ç´šç‚º Admin è§’è‰²ã€‚', 'success')
    # 4. é‚è¼¯ Bï¼šå°‡ Admin é™ç´šç‚º User
    elif user_to_demote.role == 'admin':
        user_to_demote.role = 'user'
        db.session.commit() # ğŸŒŸ å¯«å…¥è³‡æ–™åº« ğŸŒŸ
        flash(f'ä½¿ç”¨è€… {user_to_demote.email} å·²é™ç´šç‚º User è§’è‰²ã€‚', 'success')

    # 5. å¦‚æœä½¿ç”¨è€…è§’è‰²æ˜¯ userï¼Œå‰‡ç„¡éœ€æ“ä½œ
    else:
        flash(f'ä½¿ç”¨è€… {user_to_demote.email} å·²ç¶“æ˜¯æœ€ä½æ¬Šé™ï¼Œç„¡éœ€è®Šæ›´ã€‚', 'info')

    # 6. æœ€çµ‚å°å‘
    return redirect(url_for('admin_admins'))

#åˆªé™¤ä½¿ç”¨è€…è·¯ç”±

@login_required 
@app.route('/admin/delete/<int:user_id>')
def delete_user(user_id):
    # 1. æ¬Šé™æª¢æŸ¥ï¼šç¢ºä¿æ˜¯ Super Admin
    allowed_roles = ['super_admin']
    if current_user.role not in allowed_roles: 
        flash('æ¬Šé™ä¸è¶³ï¼æ‚¨æ²’æœ‰æ¬Šé™åˆªé™¤ä½¿ç”¨è€…ã€‚', 'danger')
        return redirect(url_for('index'))

    # 2. æ‰¾åˆ°è¦åˆªé™¤çš„ä½¿ç”¨è€…
    user_to_delete = User.query.get_or_404(user_id)

    # 3. é˜²è­·æ©Ÿåˆ¶ï¼šé˜²æ­¢ Admin åˆªé™¤è‡ªå·±çš„å¸³è™Ÿ (é‡è¦!)
    if user_to_delete.id == current_user.id:
        flash('æ‚¨ä¸èƒ½åˆªé™¤æ‚¨è‡ªå·±çš„å¸³è™Ÿï¼', 'danger')
        # é€™è£¡æ‡‰è©²å°å‘ç®¡ç†å“¡åˆ—è¡¨ï¼Œè€Œä¸æ˜¯ admin_users (ç¨‹å¼ç¢¼ä¸­æ²’æœ‰é€™å€‹è·¯ç”±)
        return redirect(url_for('admin_admins')) 

    # 4. åŸ·è¡Œåˆªé™¤æ“ä½œ
    try:
        # æ³¨æ„ï¼šReservation æ¨¡å‹ä¸­å·²è¨­å®š cascade="all, delete-orphan"ï¼Œåˆªé™¤ User æ™‚æœƒè‡ªå‹•åˆªé™¤ç›¸é—œé ç´„
        db.session.delete(user_to_delete)
        db.session.commit() # ğŸŒŸ ç¢ºä¿é€™ä¸€è¡ŒæˆåŠŸåŸ·è¡Œ ğŸŒŸ
        flash(f'ä½¿ç”¨è€… {user_to_delete.email} å·²æˆåŠŸå¾è³‡æ–™åº«ä¸­åˆªé™¤ï¼', 'success')

    except Exception as e:
        db.session.rollback() # å¦‚æœå‡ºéŒ¯ï¼Œå›æ»¾æ“ä½œ
        flash(f'åˆªé™¤å¤±æ•—ï¼šç™¼ç”ŸéŒ¯èª¤ã€‚éŒ¯èª¤ï¼š{e}', 'danger')

    # æœ€çµ‚å°å‘ï¼šæ ¹æ“šè¢«åˆªé™¤è€…çš„è§’è‰²å°å‘æ­£ç¢ºçš„æ¸…å–®
    if user_to_delete.role == 'user':
        return redirect(url_for('admin_researchers'))
    else:
        return redirect(url_for('admin_admins'))

#æ–°å¢ Super Admin å‡ç´šè·¯ç”±

@login_required 
@app.route('/admin/promote_super/<int:target_user_id>', methods=['GET', 'POST'])
def promote_super_admin(target_user_id):
    # 1. æ¬Šé™æª¢æŸ¥ï¼šåªæœ‰ Admin (admin æˆ– super_admin) æ‰èƒ½è¨ªå•é€™å€‹é é¢
    allowed_roles = ['admin', 'super_admin']
    if current_user.role not in allowed_roles:
        flash('æ¬Šé™ä¸è¶³ï¼æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤ç®¡ç†é é¢ã€‚', 'danger')
        return redirect(url_for('index'))

    # 2. ç¢ºä¿åªæœ‰ Super Admin æ‰èƒ½åŸ·è¡Œå¯«å…¥æ“ä½œ
    if current_user.role != 'super_admin':
        flash('æ‚¨éœ€è¦ç¸½ç®¡ç†å“¡æ¬Šé™æ‰èƒ½åŸ·è¡Œæ­¤æ“ä½œã€‚', 'danger')
        return redirect(url_for('admin_admins'))

    # 3. å¯¦ä¾‹åŒ–è¡¨å–®ä¸¦ç²å–ç›®æ¨™ä½¿ç”¨è€…
    # ğŸš¨ ä¿®æ­£ï¼šæ‚¨éœ€è¦åœ¨ forms.py ä¸­å®šç¾© Formï¼Œä¸¦ç¢ºä¿å·²åœ¨é ‚éƒ¨å°å…¥ã€‚
    try:
        from forms import SuperAdminForm
    except ImportError:
        # å¦‚æœ forms.py ä¸­æ²’æœ‰é€™å€‹è¡¨å–®ï¼Œæ‚¨å°‡éœ€è¦åœ¨è©²æª”æ¡ˆä¸­æ·»åŠ å®ƒ
        flash("éŒ¯èª¤ï¼šç¼ºå°‘ SuperAdminForm å®šç¾©ã€‚è«‹æª¢æŸ¥ forms.pyã€‚", 'danger')
        return redirect(url_for('admin_admins'))

    form = SuperAdminForm()
    user_to_promote = User.query.get_or_404(target_user_id)

    # 4. è™•ç†è¡¨å–®æäº¤
    if form.validate_on_submit():
        if form.super_key.data == SUPER_ADMIN_KEY:
            # å¯†é‘°æ­£ç¢ºï¼ŒåŸ·è¡Œå‡ç´š
            user_to_promote.role = 'super_admin'
            db.session.commit()
            flash(f'ä½¿ç”¨è€… {user_to_promote.email} å·²æˆåŠŸå‡ç´šç‚ºç¸½ç®¡ç†å“¡ (Super Admin)ï¼', 'success')
            return redirect(url_for('admin_admins'))
        else:
            # å¯†é‘°éŒ¯èª¤
            flash('ç¸½ç®¡ç†å“¡å¯†é‘°ä¸æ­£ç¢ºï¼Œå‡ç´šå¤±æ•—ã€‚', 'danger')

    # 5. æ¸²æŸ“æ¨¡æ¿
    return render_template('promote_super_admin.html', 
                            form=form, 
                            user=user_to_promote,
                            target_user_id=target_user_id)


# æ‡‰ç”¨ç¨‹å¼çš„å•Ÿå‹•é»
if __name__ == '__main__':
Â  Â  with app.app_context():
Â  Â  Â  Â  db.create_all()
Â  Â  Â  Â  print("è³‡æ–™åº«è¡¨æ ¼å·²æª¢æŸ¥ä¸¦å»ºç«‹å®Œæˆ (reservations.db)ã€‚")

Â  Â  app.run(debug=True)
# ----------------------------------------------------

è«‹é™¤éŒ¯ä¸¦çµ¦äºˆè©³ç´°ç¨‹å¼ç¢¼